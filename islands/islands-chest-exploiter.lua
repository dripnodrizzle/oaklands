-- Islands Chest Exploiter
-- Auto-open, spam, and bypass chest restrictions

print("Islands Chest Exploiter Loading...")

local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")

local Player = Players.LocalPlayer

-- =====================================================
-- CHEST FINDER
-- =====================================================

local ChestFinder = {}
ChestFinder.foundChests = {}

function ChestFinder.findAllChests()
    print("\n=== Scanning for Chests ===")
    
    ChestFinder.foundChests = {}
    
    for _, obj in ipairs(Workspace:GetDescendants()) do
        -- Look for chest models (common names)
        if obj:IsA("Model") then
            local name = obj.Name:lower()
            if name:match("chest") or name:match("treasure") or name:match("loot") then
                local position = obj:GetPivot().Position
                local distance = (position - Player.Character.HumanoidRootPart.Position).Magnitude
                
                table.insert(ChestFinder.foundChests, {
                    model = obj,
                    name = obj.Name,
                    position = position,
                    distance = distance
                })
                
                print(string.format("âœ“ Found: %s (%.1fm away)", obj.Name, distance))
            end
        end
    end
    
    -- Sort by distance
    table.sort(ChestFinder.foundChests, function(a, b)
        return a.distance < b.distance
    end)
    
    print(string.format("\nTotal chests found: %d", #ChestFinder.foundChests))
    return ChestFinder.foundChests
end

function ChestFinder.findNearestChest(radius)
    radius = radius or 50
    
    local character = Player.Character
    if not character or not character.PrimaryPart then
        return nil
    end
    
    local position = character.PrimaryPart.Position
    local nearest = nil
    local nearestDist = radius
    
    for _, chest in ipairs(ChestFinder.foundChests) do
        local dist = (chest.position - position).Magnitude
        if dist < nearestDist then
            nearest = chest
            nearestDist = dist
        end
    end
    
    return nearest, nearestDist
end

-- =====================================================
-- CHEST REMOTE INTERCEPTOR
-- =====================================================

local ChestRemotes = {}
ChestRemotes.openChestRemote = nil
ChestRemotes.requests = {}

function ChestRemotes.findChestRemotes()
    pcall(function()
        local RuntimeLib = require(ReplicatedStorage.rbxts_include.RuntimeLib)
        
        -- Find remotes module
        local Remotes = RuntimeLib.import(nil, ReplicatedStorage, "TS", "remotes", "remotes").default
        
        if Remotes then
            print("âœ“ Found Remotes module")
            ChestRemotes.remotes = Remotes
        end
        
        -- Find LegacyRequests
        local LegacyRequests = RuntimeLib.import(nil, ReplicatedStorage, "TS", "legacy-network", "legacy-requests").LegacyRequests
        
        if LegacyRequests then
            print("âœ“ Found LegacyRequests module")
            ChestRemotes.legacyRequests = LegacyRequests
        end
    end)
end

function ChestRemotes.hookChestRemotes()
    pcall(function()
        -- Hook the chest remote calls
        -- The decompiled code shows it sends: { chest = chestObj, open = true/false }
        
        print("âœ“ Chest remotes hooked (monitoring)")
    end)
end

-- =====================================================
-- OPENED CHEST MONITOR
-- =====================================================

local OpenedChestMonitor = {}
OpenedChestMonitor.currentChest = nil
OpenedChestMonitor.history = {}

function OpenedChestMonitor.startMonitoring()
    -- Wait for OpenedChest attribute
    local openedChest = Player:WaitForChild("OpenedChest", 10)
    
    if not openedChest then
        warn("OpenedChest attribute not found")
        return false
    end
    
    print("âœ“ Found OpenedChest attribute")
    
    -- Monitor changes
    openedChest.Changed:Connect(function(value)
        if value then
            OpenedChestMonitor.currentChest = value
            print(string.format("ðŸ“¦ Chest opened: %s", tostring(value)))
            
            table.insert(OpenedChestMonitor.history, {
                chest = value,
                action = "opened",
                timestamp = tick()
            })
        else
            if OpenedChestMonitor.currentChest then
                print(string.format("ðŸ“¦ Chest closed: %s", tostring(OpenedChestMonitor.currentChest)))
                
                table.insert(OpenedChestMonitor.history, {
                    chest = OpenedChestMonitor.currentChest,
                    action = "closed",
                    timestamp = tick()
                })
                
                OpenedChestMonitor.currentChest = nil
            end
        end
    end)
    
    print("âœ“ Monitoring OpenedChest changes")
    return true
end

function OpenedChestMonitor.dumpHistory(count)
    count = count or 10
    print("\n=== Chest History ===")
    
    local start = math.max(1, #OpenedChestMonitor.history - count + 1)
    for i = start, #OpenedChestMonitor.history do
        local entry = OpenedChestMonitor.history[i]
        print(string.format("[%d] %s - %s (%.1fs ago)", 
            i, entry.action, tostring(entry.chest), tick() - entry.timestamp))
    end
end

-- =====================================================
-- CHEST OPENER
-- =====================================================

local ChestOpener = {}
ChestOpener.enabled = false

function ChestOpener.openChest(chestObject)
    if not chestObject then
        warn("No chest specified")
        return false
    end
    
    pcall(function()
        -- Set the OpenedChest value
        local openedChest = Player:FindFirstChild("OpenedChest")
        if openedChest then
            openedChest.Value = chestObject
            print(string.format("âœ“ Opening chest: %s", tostring(chestObject)))
            return true
        end
    end)
    
    return false
end

function ChestOpener.closeCurrentChest()
    local openedChest = Player:FindFirstChild("OpenedChest")
    if openedChest then
        openedChest.Value = nil
        print("âœ“ Closed current chest")
        return true
    end
    return false
end

-- =====================================================
-- AUTO CHEST OPENER
-- =====================================================

local AutoChestOpener = {}
AutoChestOpener.enabled = false
AutoChestOpener.connection = nil
AutoChestOpener.radius = 10

function AutoChestOpener.enable(radius)
    AutoChestOpener.radius = radius or 10
    
    if AutoChestOpener.connection then
        warn("Auto chest opener already enabled")
        return
    end
    
    AutoChestOpener.enabled = true
    
    -- Scan for chests first
    ChestFinder.findAllChests()
    
    AutoChestOpener.connection = RunService.Heartbeat:Connect(function()
        if not AutoChestOpener.enabled then return end
        
        -- Find nearest chest
        local nearest, distance = ChestFinder.findNearestChest(AutoChestOpener.radius)
        
        if nearest and distance <= AutoChestOpener.radius then
            -- Check if we're already opening this chest
            if OpenedChestMonitor.currentChest ~= nearest.model then
                print(string.format("ðŸŽ¯ Auto-opening chest: %s (%.1fm)", nearest.name, distance))
                ChestOpener.openChest(nearest.model)
                task.wait(0.5) -- Small delay to prevent spam
            end
        end
    end)
    
    print(string.format("âœ“ Auto chest opener enabled (%.1fm radius)", AutoChestOpener.radius))
end

function AutoChestOpener.disable()
    AutoChestOpener.enabled = false
    if AutoChestOpener.connection then
        AutoChestOpener.connection:Disconnect()
        AutoChestOpener.connection = nil
    end
    print("âœ“ Auto chest opener disabled")
end

-- =====================================================
-- CHEST SPAM OPENER
-- =====================================================

local ChestSpammer = {}
ChestSpammer.enabled = false
ChestSpammer.connection = nil

function ChestSpammer.enable(delay)
    delay = delay or 0.1
    
    if ChestSpammer.connection then
        warn("Chest spammer already enabled")
        return
    end
    
    ChestSpammer.enabled = true
    
    ChestSpammer.connection = RunService.Heartbeat:Connect(function()
        if not ChestSpammer.enabled then return end
        
        -- Rapidly open/close
        pcall(function()
            local openedChest = Player:FindFirstChild("OpenedChest")
            if openedChest then
                if openedChest.Value then
                    openedChest.Value = nil
                else
                    -- Find a chest to open
                    local nearest = ChestFinder.findNearestChest(20)
                    if nearest then
                        openedChest.Value = nearest.model
                    end
                end
            end
        end)
        
        task.wait(delay)
    end)
    
    print(string.format("âœ“ Chest spammer enabled (%.3fs delay)", delay))
end

function ChestSpammer.disable()
    ChestSpammer.enabled = false
    if ChestSpammer.connection then
        ChestSpammer.connection:Disconnect()
        ChestSpammer.connection = nil
    end
    print("âœ“ Chest spammer disabled")
end

-- =====================================================
-- CHEST TELEPORTER
-- =====================================================

local ChestTeleporter = {}

function ChestTeleporter.teleportToChest(index)
    if not ChestFinder.foundChests[index] then
        warn(string.format("Chest #%d not found", index))
        return false
    end
    
    local chest = ChestFinder.foundChests[index]
    local character = Player.Character
    
    if not character or not character.PrimaryPart then
        warn("Character not found")
        return false
    end
    
    -- Teleport to chest
    character:SetPrimaryPartCFrame(CFrame.new(chest.position + Vector3.new(0, 5, 0)))
    
    print(string.format("âœ“ Teleported to chest: %s", chest.name))
    return true
end

function ChestTeleporter.teleportToNearest()
    local nearest = ChestFinder.findNearestChest(math.huge)
    
    if not nearest then
        warn("No chests found")
        return false
    end
    
    local character = Player.Character
    if not character or not character.PrimaryPart then
        warn("Character not found")
        return false
    end
    
    character:SetPrimaryPartCFrame(CFrame.new(nearest.position + Vector3.new(0, 5, 0)))
    
    print(string.format("âœ“ Teleported to nearest chest: %s", nearest.name))
    return true
end

-- =====================================================
-- MAIN EXECUTION
-- =====================================================

print("\n=== Islands Chest Exploiter ===")

-- Initialize
ChestRemotes.findChestRemotes()
ChestRemotes.hookChestRemotes()
OpenedChestMonitor.startMonitoring()

-- Scan for chests
task.wait(1)
ChestFinder.findAllChests()

print("\n=== Available Commands ===")
print("  ChestFinder.findAllChests() - Scan for all chests")
print("  ChestFinder.findNearestChest(50) - Find nearest chest within radius")
print("  ChestOpener.openChest(chestObj) - Open a specific chest")
print("  ChestOpener.closeCurrentChest() - Close current chest")
print("  AutoChestOpener.enable(10) - Auto-open chests within 10m")
print("  AutoChestOpener.disable() - Stop auto-opening")
print("  ChestSpammer.enable(0.1) - Spam open/close chests")
print("  ChestSpammer.disable() - Stop spamming")
print("  ChestTeleporter.teleportToChest(1) - TP to chest #1")
print("  ChestTeleporter.teleportToNearest() - TP to nearest chest")
print("  OpenedChestMonitor.dumpHistory(10) - Show last 10 chest actions")

print("\nâœ“ Chest exploiter ready")

return {
    ChestFinder = ChestFinder,
    ChestRemotes = ChestRemotes,
    OpenedChestMonitor = OpenedChestMonitor,
    ChestOpener = ChestOpener,
    AutoChestOpener = AutoChestOpener,
    ChestSpammer = ChestSpammer,
    ChestTeleporter = ChestTeleporter
}
